<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FG Operations Waste/Disposal Reporting</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Additional styles for dual chart layout */
        .dual-chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }
        
        .chart-card {
            background: var(--color-white);
            border-radius: var(--border-radius);
            border: var(--border-base);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: all var(--transition-fast);
        }
        
        .chart-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: var(--border-thin);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .chart-card-header h3 {
            color: var(--color-primary);
            font-size: var(--font-size-md);
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            flex: 1;
            min-width: 0;
        }
        
        .chart-card-type-selector {
            display: flex;
            gap: 4px;
            background: var(--color-offwhite);
            border-radius: var(--border-radius-sm);
            padding: 2px;
            border: var(--border-thin);
            flex-shrink: 0;
        }
        
        .chart-card-type-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: var(--font-size-xs);
            color: var(--color-gray);
            transition: all var(--transition-fast);
            width: 30px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chart-card-type-btn:hover {
            color: var(--color-primary);
            background: rgba(42, 89, 52, 0.1);
        }
        
        .chart-card-type-btn.active {
            background: var(--color-primary);
            color: white;
        }
        
        .chart-card-body {
            flex: 1;
            position: relative;
            min-height: 250px;
            width: 100%;
            overflow: hidden;
        }
        
        .chart-card-footer {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-sm);
            border-top: var(--border-thin);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-xs);
            color: var(--color-gray);
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }
        
        .chart-card-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }
        
        .chart-card-stat i {
            color: var(--color-primary);
            flex-shrink: 0;
        }
        
        /* Mobile Responsive */
        @media (max-width: 992px) {
            .dual-chart-container {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .chart-card-body {
                min-height: 250px;
            }
        }
        
        @media (max-width: 768px) {
            .chart-card {
                padding: var(--spacing-sm);
            }
            
            .chart-card-body {
                min-height: 220px;
            }
            
            .chart-card-header h3 {
                font-size: var(--font-size-sm);
            }
            
            .chart-card-footer {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .chart-card-stat {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        @media (max-width: 480px) {
            .chart-card-body {
                min-height: 200px;
            }
            
            .chart-card {
                padding: 12px;
            }
            
            #complianceChart, #costChart {
                max-height: 180px !important;
                width: 100% !important;
            }
        }
        
        /* Quick Stats Section */
        .quick-stats-section {
            margin: var(--spacing-xl) 0;
            background: var(--color-white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-lg);
            border: var(--border-base);
        }
        
        .quick-stats-section h2 {
            color: var(--color-primary);
            margin-bottom: var(--spacing-lg);
            font-size: var(--font-size-lg);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }
        
        .quick-stat-card {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--color-offwhite);
            border-radius: var(--border-radius);
            border: var(--border-thin);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            height: 100%;
        }
        
        .quick-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }
        
        .quick-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--color-primary);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .quick-stat-card:hover::before {
            opacity: 1;
        }
        
        .stat-icon-mini {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-white);
            background: var(--color-primary);
            font-size: var(--font-size-md);
            flex-shrink: 0;
            transition: transform var(--transition-fast);
        }
        
        .quick-stat-card:hover .stat-icon-mini {
            transform: scale(1.1);
        }
        
        .stat-content-mini {
            flex: 1;
            min-width: 0;
        }
        
        .stat-content-mini h4 {
            font-size: var(--font-size-xs);
            color: var(--color-gray);
            margin-bottom: 4px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .value-large {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 2px;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .subtext {
            font-size: var(--font-size-xs);
            color: var(--color-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Chart Statistics */
        .chart-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }
        
        .chart-stat-card {
            background: var(--color-offwhite);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            border: var(--border-thin);
            transition: all var(--transition-fast);
        }
        
        .chart-stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }
        
        .chart-stat-card h4 {
            font-size: var(--font-size-sm);
            color: var(--color-darkgray);
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .chart-stat-card .value {
            font-size: var(--font-size-xl);
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 2px;
        }
        
        .chart-stat-card .subtext {
            font-size: var(--font-size-xs);
            color: var(--color-gray);
        }
        
        /* Chart Footer */
        .chart-footer {
            margin-top: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--color-offwhite);
            border-radius: var(--border-radius);
            border: var(--border-thin);
        }
        
        .chart-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-sm);
            color: var(--color-gray);
        }
        
        /* Mobile Responsive for Stats */
        @media (max-width: 768px) {
            .stat-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-sm);
            }
            
            .quick-stat-card {
                padding: var(--spacing-sm);
                gap: var(--spacing-sm);
            }
            
            .stat-icon-mini {
                width: 32px;
                height: 32px;
                font-size: var(--font-size-sm);
            }
            
            .value-large {
                font-size: var(--font-size-lg);
            }
            
            .chart-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--spacing-sm);
            }
            
            .chart-stat-card {
                padding: var(--spacing-sm);
            }
            
            .chart-stat-card .value {
                font-size: var(--font-size-lg);
            }
            
            .chart-info {
                font-size: var(--font-size-xs);
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .stat-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-stats {
                grid-template-columns: 1fr;
            }
        }
        
        /* Percentage indicator */
        .percentage-badge {
            background: var(--color-primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification" class="notification"></div>
    
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-brand">
                <img src="logo.jpg" alt="FG Operations Logo" class="nav-logo">
                <span>FG Operations</span>
            </div>
            <ul class="nav-links">
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="submit_waste_report.html">Report Waste</a></li>
                <li><a href="waste_report_table.html">View Reports</a></li>
            </ul>
            <div class="nav-actions">
                <button class="btn btn-primary" onclick="window.location.href='submit_waste_report.html'">
                    <i class="fas fa-plus"></i> Submit Report
                </button>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <h1>FG Operations Waste/Disposal Reporting</h1>
                <p class="subtitle">Daily Reporting System</p>
                <p>Submit daily reports for expired items and waste, or view previously submitted reports.</p><br>
                <div class="hero-buttons">
                    <button class="btn btn-primary btn-large" onclick="window.location.href='submit_waste_report.html'">
                        <i class="fas fa-file-alt"></i> Submit Waste Report
                    </button>
                    <button class="btn btn-secondary btn-large" onclick="window.location.href='waste_report_table.html'">
                        <i class="fas fa-list"></i> View Reports
                    </button>
                </div>
            </div>
        </section>

        <!-- Dual Charts Section -->
        <section class="chart-section">
            <div class="chart-header">
                <h2><i class="fas fa-chart-bar"></i> Current Month Performance</h2>
                <div style="display: flex; gap: 15px; margin-top: 5px; flex-wrap: wrap;">
                    <span style="font-size: 13px; color: var(--color-gray); background: rgba(40, 167, 69, 0.1); padding: 4px 12px; border-radius: 20px;">
                        <i class="fas fa-check-circle" style="color: #28a745;"></i> Compliance Rate: % of days reported
                    </span>
                    <span style="font-size: 13px; color: var(--color-gray); background: rgba(220, 53, 69, 0.1); padding: 4px 12px; border-radius: 20px;">
                        <i class="fas fa-percent" style="color: #dc3545;"></i> Waste Cost Share: % of total approved waste cost
                    </span>
                </div>
                <div style="margin-top: 10px; font-size: 12px; color: var(--color-primary); font-weight: 500;" id="currentMonthDisplay">
                    Loading current month...
                </div>
            </div>

            <!-- Dual Chart Container -->
            <div class="dual-chart-container">
                <!-- Compliance Rate Chart Card - CURRENT MONTH ONLY -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3><i class="fas fa-check-circle" style="color: #28a745;"></i> Compliance Rate</h3>
                        <div class="chart-card-type-selector">
                            <button class="chart-card-type-btn active" data-chart="compliance-pie" data-metric="compliance">
                                <i class="fas fa-chart-pie"></i>
                            </button>
                            <button class="chart-card-type-btn" data-chart="compliance-bar" data-metric="compliance">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-card-body">
                        <canvas id="complianceChart"></canvas>
                    </div>
                    <div class="chart-card-footer">
                        <div class="chart-card-stat">
                            <i class="fas fa-store"></i>
                            <span id="complianceStoreCount">0 stores</span>
                        </div>
                        <div class="chart-card-stat">
                            <i class="fas fa-chart-line"></i>
                            <span id="complianceAverage">0% avg</span>
                        </div>
                        <div class="chart-card-stat">
                            <i class="fas fa-calendar"></i>
                            <span id="complianceDays">Current month</span>
                        </div>
                    </div>
                </div>

                <!-- Waste Cost Share Chart Card - CURRENT MONTH ONLY (PERCENTAGE) -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3><i class="fas fa-percent" style="color: #dc3545;"></i> Waste Cost Share</h3>
                        <div class="chart-card-type-selector">
                            <button class="chart-card-type-btn active" data-chart="cost-pie" data-metric="cost">
                                <i class="fas fa-chart-pie"></i>
                            </button>
                            <button class="chart-card-type-btn" data-chart="cost-bar" data-metric="cost">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-card-body">
                        <canvas id="costChart"></canvas>
                    </div>
                    <div class="chart-card-footer">
                        <div class="chart-card-stat">
                            <i class="fas fa-store"></i>
                            <span id="costStoreCount">0 stores</span>
                        </div>
                        <div class="chart-card-stat">
                            <i class="fas fa-percent"></i>
                            <span id="costAverage">0% avg share</span>
                        </div>
                        <div class="chart-card-stat">
                            <i class="fas fa-chart-pie"></i>
                            <span id="totalWasteCost">100% total</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combined Chart Statistics -->
            <div class="chart-stats">
                <div class="chart-stat-card">
                    <h4><i class="fas fa-store"></i> Top Compliance</h4>
                    <div class="value" id="topComplianceStore">-</div>
                    <div class="subtext" id="topComplianceValue">0%</div>
                </div>
                
                <div class="chart-stat-card">
                    <h4><i class="fas fa-chart-line"></i> Avg Compliance</h4>
                    <div class="value" id="overallComplianceAvg">0%</div>
                    <div class="subtext">This Month</div>
                </div>
                
                <div class="chart-stat-card">
                    <h4><i class="fas fa-percent"></i> Highest Share</h4>
                    <div class="value" id="topCostStore">-</div>
                    <div class="subtext" id="topCostValue">0%</div>
                </div>
                
                <div class="chart-stat-card">
                    <h4><i class="fas fa-calculator"></i> Stores with Waste</h4>
                    <div class="value" id="overallCostTotal">0</div>
                    <div class="subtext">out of 12 stores</div>
                </div>
            </div>
            
            <!-- Chart Footer -->
            <div class="chart-footer">
                <div class="chart-info">
                    <i class="fas fa-info-circle"></i> 
                    <span><strong>Both charts show CURRENT MONTH data only</strong> â€¢ Compliance: % of days with approved reports â€¢ Waste Share: % of total approved waste cost (â‚± values hidden)</span>
                </div>
            </div>
        </section>

        <!-- Quick Stats Section -->
        <section class="quick-stats-section">
            <h2><i class="fas fa-tachometer-alt"></i> Current Month Overview</h2>
            <div class="stat-grid">
                <div class="quick-stat-card">
                    <div class="stat-icon-mini">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="stat-content-mini">
                        <h4>Total Stores</h4>
                        <div class="value-large">12</div>
                        <div class="subtext">Active locations</div>
                    </div>
                </div>
                
                <div class="quick-stat-card">
                    <div class="stat-icon-mini">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content-mini">
                        <h4>Reports This Month</h4>
                        <div class="value-large" id="totalReports">0</div>
                        <div class="subtext" id="totalStoresWithReports">0 stores</div>
                    </div>
                </div>
                
                <div class="quick-stat-card">
                    <div class="stat-icon-mini">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content-mini">
                        <h4>Needs Attention</h4>
                        <div class="value-large" id="needsAttention">-</div>
                        <div class="subtext" id="attentionReason">Low compliance</div>
                    </div>
                </div>
                
                <div class="quick-stat-card">
                    <div class="stat-icon-mini">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="stat-content-mini">
                        <h4>Updated</h4>
                        <div class="value-large" id="lastUpdatedTime">-</div>
                        <div class="subtext">Just now</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Store Locations -->
        <section class="features">
            <h2><i class="fas fa-map-marker-alt"></i> Available Store Locations</h2>
            <div class="store-grid">
                <div class="store-card">
                    <h3>FG Express Stores</h3>
                    <ul class="store-list">
                        <li>FG Express IROSIN</li>
                        <li>FG Express LIGAO</li>
                        <li>FG Express POLANGUI</li>
                        <li>FG Express MASBATE</li>
                        <li>FG Express DARAGA</li>
                        <li>FG Express BAAO</li>
                        <li>FG Express PIODURAN</li>
                        <li>FG Express RIZAL</li>
                    </ul>
                </div>
                <div class="store-card">
                    <h3>FG to go & Main Stores</h3>
                    <ul class="store-list">
                        <li>FG to go TABACO</li>
                        <li>FG to go LEGAZPI</li>
                        <li>FG LEGAZPI</li>
                        <li>FG NAGA</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-brand">
                    <img src="logo.jpg" alt="FG Operations Logo" class="footer-logo">
                    <span>FG Operations Waste/Disposal Reporting System v1.0</span>
                </div>
                <div class="footer-links">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                    <a href="submit_waste_report.html"><i class="fas fa-file-alt"></i> Submit Report</a>
                    <a href="waste_report_table.html"><i class="fas fa-list"></i> View Reports</a>
                </div>
                <p class="copyright">This form was created as a standalone HTML version with Firebase backend.</p>
            </div>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
    // ================================
    // CONFIGURATION
    // ================================

    // Firestore configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAyp2f1b6cG4E_Dx9eako31LgTDuZrZ8_E",
        authDomain: "disposal-e6b83.firebaseapp.com",
        projectId: "disposal-e6b83",
        storageBucket: "disposal-e6b83.firebasestorage.app",
        messagingSenderId: "1050986320678",
        appId: "1:1050986320678:web:deb5f4c58c3ef0cbc6a7e7",
        measurementId: "G-3Q7705T5FE"
    };

    // ================================
    // GLOBAL VARIABLES
    // ================================
    let db;
    let complianceChart = null;
    let costChart = null;
    let currentComplianceChartType = 'pie';
    let currentCostChartType = 'pie';
    let currentData = null;
    let dataCache = {
        reports: [],
        timestamp: 0,
        ttl: 5 * 60 * 1000, // 5 minutes cache
        statistics: null
    };

    // Define all store names
    const ALL_STORES = [
        'FG Express IROSIN',
        'FG Express LIGAO',
        'FG Express POLANGUI',
        'FG Express MASBATE',
        'FG Express DARAGA',
        'FG Express BAAO',
        'FG Express PIODURAN',
        'FG Express RIZAL',
        'FG to go TABACO',
        'FG to go LEGAZPI',
        'FG LEGAZPI',
        'FG NAGA'
    ];

    // Store display names for chart
    const STORE_DISPLAY_NAMES = {
        'FG Express IROSIN': 'IROSIN',
        'FG Express LIGAO': 'LIGAO',
        'FG Express POLANGUI': 'POLANGUI',
        'FG Express MASBATE': 'MASBATE',
        'FG Express DARAGA': 'DARAGA',
        'FG Express BAAO': 'BAAO',
        'FG Express PIODURAN': 'PIODURAN',
        'FG Express RIZAL': 'RIZAL',
        'FG to go TABACO': 'TABACO',
        'FG to go LEGAZPI': 'LEGAZPI (to go)',
        'FG LEGAZPI': 'LEGAZPI',
        'FG NAGA': 'NAGA'
    };

    // Colors for charts
    const CHART_COLORS = [
        '#28a745', '#20c997', '#17a2b8', '#0dcaf0',
        '#ffc107', '#fd7e14', '#dc3545', '#6c757d',
        '#6610f2', '#6f42c1', '#d63384', '#198754'
    ];

    // ================================
    // OPTIMIZED UTILITY FUNCTIONS
    // ================================
    function formatPercentage(value) {
        return Math.round(value) + '%';
    }

    // ================================
    // OPTIMIZED LOADING & NOTIFICATION
    // ================================
    function showNotification(message, type = 'success', duration = 3000) {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        if (notification.timeoutId) {
            clearTimeout(notification.timeoutId);
        }
        
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        notification.style.animation = 'slideInRight 0.3s ease';
        
        notification.timeoutId = setTimeout(() => {
            notification.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                notification.style.display = 'none';
                notification.style.animation = '';
            }, 300);
        }, duration);
        
        return notification;
    }

    function showLoading(show, message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) return;
        
        requestAnimationFrame(() => {
            overlay.style.display = show ? 'flex' : 'none';
            if (show && message !== 'Loading...') {
                const spinner = overlay.querySelector('.loading-spinner');
                if (spinner) {
                    spinner.style.marginBottom = '15px';
                    const existingText = spinner.nextElementSibling;
                    if (existingText && existingText.tagName === 'P') {
                        existingText.textContent = message;
                    } else {
                        const text = document.createElement('p');
                        text.textContent = message;
                        text.style.cssText = 'color: white; margin: 0; font-size: 14px; text-align: center;';
                        overlay.appendChild(text);
                    }
                }
            }
        });
    }

    // ================================
    // FIREBASE INITIALIZATION
    // ================================
    function initializeFirebase() {
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            
            // Load all data
            loadAllData();
            
        } catch (error) {
            console.error('âŒ Firebase initialization error:', error);
            showNotification('Firebase connection failed. Please check console.', 'error');
        }
    }

    // ================================
    // DATA LOADING FUNCTIONS - BOTH CHARTS SHOW CURRENT MONTH
    // ================================
    async function loadAllData() {
        showLoading(true, 'Loading current month data...');
        
        try {
            const now = Date.now();
            
            // Check cache
            if (dataCache.reports.length > 0 && 
                dataCache.statistics && 
                (now - dataCache.timestamp) < dataCache.ttl) {
                
                console.log('ðŸ“Š Using cached data');
                currentData = dataCache.statistics;
                updateAllChartsAndStats();
                showLoading(false);
                return;
            }
            
            // Get ALL reports
            const snapshot = await db.collection('wasteReports')
                .orderBy('reportDate', 'desc')
                .get();
            
            if (snapshot.empty) {
                createEmptyCharts();
                updateEmptyStats();
                showLoading(false);
                return;
            }
            
            // Process reports
            const reports = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                reports.push({ 
                    id: doc.id, 
                    ...data,
                    disposalTypes: Array.isArray(data.disposalTypes) ? data.disposalTypes : 
                                  data.disposalType ? [data.disposalType] : ['unknown']
                });
            });
            
            console.log(`âœ… Loaded ${reports.length} total reports`);
            
            // Cache the data
            dataCache.reports = reports;
            dataCache.timestamp = now;
            
            // Calculate compliance data - CURRENT MONTH ONLY
            const complianceData = calculateComplianceData(reports);
            
            // Calculate cost share data - CURRENT MONTH ONLY (PERCENTAGES)
            const costData = calculateCostShareDataCurrentMonth(reports);
            
            // Store statistics
            dataCache.statistics = {
                compliance: complianceData,
                cost: costData,
                totalReports: reports.length
            };
            
            // Store data globally
            currentData = dataCache.statistics;
            
            console.log('ðŸ“Š Current Month Cost Share Data:', {
                month: complianceData.month,
                daysSoFar: complianceData.daysSoFar,
                storesWithCost: costData.storeCount,
                topStore: costData.topStore,
                topPercentage: costData.topPercentage,
                results: costData.results.map(r => ({ 
                    store: r.store, 
                    percentage: r.percentage
                }))
            });
            
            // Update all charts and stats
            updateAllChartsAndStats();
            
        } catch (error) {
            console.error('Error loading data:', error);
            showNotification('Error loading data: ' + error.message, 'error');
            createEmptyCharts();
        } finally {
            showLoading(false);
        }
    }

    function updateAllChartsAndStats() {
        if (!currentData) return;
        
        updateComplianceChart();
        updateCostChart();
        updateStats();
    }

    // ================================
    // COMPLIANCE CALCULATION - CURRENT MONTH ONLY
    // ================================
    function calculateComplianceData(reports) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const currentDay = now.getDate();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const daysSoFar = Math.min(currentDay, daysInMonth);
        
        // Initialize store data
        const storeData = {};
        ALL_STORES.forEach(store => {
            storeData[store] = {
                reportedDays: new Set(),
                totalReports: 0,
                hasApprovedItems: false
            };
        });
        
        // Process reports - ONLY CURRENT MONTH
        reports.forEach(report => {
            const store = report.store;
            if (!store || !storeData[store]) return;
            
            const reportDate = new Date(report.reportDate);
            
            // Only include reports from current month
            if (reportDate.getFullYear() !== currentYear || reportDate.getMonth() !== currentMonth) {
                return;
            }
            
            // Check if report is approved (has at least one approved item OR is no-waste)
            let isReportApproved = false;
            
            // No-waste reports are automatically approved
            if (report.disposalTypes?.includes('noWaste')) {
                isReportApproved = true;
            } else {
                // Check for approved items
                const expiredItems = report.expiredItems || [];
                const wasteItems = report.wasteItems || [];
                
                for (let i = 0; i < expiredItems.length; i++) {
                    if (expiredItems[i].approvalStatus === 'approved') {
                        isReportApproved = true;
                        storeData[store].hasApprovedItems = true;
                        break;
                    }
                }
                
                if (!isReportApproved) {
                    for (let i = 0; i < wasteItems.length; i++) {
                        if (wasteItems[i].approvalStatus === 'approved') {
                            isReportApproved = true;
                            storeData[store].hasApprovedItems = true;
                            break;
                        }
                    }
                }
            }
            
            if (isReportApproved) {
                storeData[store].totalReports++;
                storeData[store].reportedDays.add(reportDate.getDate());
            }
        });
        
        // Calculate compliance percentages
        const results = [];
        let totalCompliance = 0;
        let storeCountWithReports = 0;
        let topStore = null;
        let topValue = 0;
        let lowestStore = null;
        let lowestValue = 101;
        
        ALL_STORES.forEach(store => {
            const data = storeData[store];
            
            // Only include stores with approved reports in current month
            if (data.totalReports === 0) return;
            
            const reportedDays = data.reportedDays.size;
            const complianceRate = daysSoFar > 0 ? 
                Math.round((reportedDays / daysSoFar) * 100) : 0;
            
            results.push({
                store,
                displayName: STORE_DISPLAY_NAMES[store] || store,
                value: complianceRate,
                reportedDays,
                totalDays: daysSoFar,
                label: `${complianceRate}%`,
                description: `${reportedDays}/${daysSoFar} days`
            });
            
            totalCompliance += complianceRate;
            storeCountWithReports++;
            
            if (complianceRate > topValue) {
                topValue = complianceRate;
                topStore = store;
            }
            
            if (complianceRate < lowestValue) {
                lowestValue = complianceRate;
                lowestStore = store;
            }
        });
        
        // Sort by compliance rate (highest first)
        results.sort((a, b) => b.value - a.value);
        
        const overallAverage = storeCountWithReports > 0 ? 
            Math.round(totalCompliance / storeCountWithReports) : 0;
        
        const coverage = Math.round((storeCountWithReports / ALL_STORES.length) * 100);
        
        return {
            results,
            overallAverage,
            topStore,
            topValue,
            lowestStore,
            lowestValue,
            storeCount: storeCountWithReports,
            coverage,
            daysSoFar,
            month: now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })
        };
    }

    // ================================
    // COST SHARE CALCULATION - CURRENT MONTH ONLY (PERCENTAGES)
    // ================================
    function calculateCostShareDataCurrentMonth(reports) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        
        // Initialize store costs
        const storeCosts = {};
        ALL_STORES.forEach(store => {
            storeCosts[store] = 0;
        });
        
        // Calculate total approved cost per store - CURRENT MONTH ONLY
        let totalApprovedCost = 0;
        
        reports.forEach(report => {
            const store = report.store;
            if (!store || !storeCosts.hasOwnProperty(store)) return;
            
            const reportDate = new Date(report.reportDate);
            
            // ONLY include reports from current month
            if (reportDate.getFullYear() !== currentYear || reportDate.getMonth() !== currentMonth) {
                return;
            }
            
            // Skip no-waste reports (cost is 0)
            if (report.disposalTypes?.includes('noWaste')) {
                return;
            }
            
            let reportApprovedCost = 0;
            let hasApprovedItem = false;
            
            // Process expired items
            const expiredItems = report.expiredItems || [];
            expiredItems.forEach(item => {
                if (item.approvalStatus === 'approved') {
                    const itemCost = item.itemCost || 0;
                    const quantity = item.quantity || 0;
                    reportApprovedCost += itemCost * quantity;
                    hasApprovedItem = true;
                }
            });
            
            // Process waste items
            const wasteItems = report.wasteItems || [];
            wasteItems.forEach(item => {
                if (item.approvalStatus === 'approved') {
                    const itemCost = item.itemCost || 0;
                    const quantity = item.quantity || 0;
                    reportApprovedCost += itemCost * quantity;
                    hasApprovedItem = true;
                }
            });
            
            if (hasApprovedItem && reportApprovedCost > 0) {
                storeCosts[store] += reportApprovedCost;
                totalApprovedCost += reportApprovedCost;
            }
        });
        
        // Prepare results - SHOW PERCENTAGES ONLY, HIDE ACTUAL COSTS
        const results = [];
        let topStore = null;
        let topPercentage = 0;
        let storeCountWithCost = 0;
        
        ALL_STORES.forEach(store => {
            const cost = storeCosts[store];
            
            // Include stores with approved waste cost in current month
            if (cost > 0) {
                const percentage = totalApprovedCost > 0 ? 
                    Math.round((cost / totalApprovedCost) * 100) : 0;
                
                results.push({
                    store,
                    displayName: STORE_DISPLAY_NAMES[store] || store,
                    value: percentage, // PERCENTAGE for chart
                    percentage: percentage,
                    cost: cost, // Keep for internal calculations, NOT displayed
                    label: `${percentage}%`,
                    description: `${percentage}% of total`
                });
                
                storeCountWithCost++;
                
                if (percentage > topPercentage) {
                    topPercentage = percentage;
                    topStore = store;
                }
            }
        });
        
        // Sort by percentage (highest first)
        results.sort((a, b) => b.value - a.value);
        
        // Calculate average percentage per store (with costs)
        const averagePercentage = storeCountWithCost > 0 ? 
            Math.round(results.reduce((sum, r) => sum + r.percentage, 0) / storeCountWithCost) : 0;
        
        return {
            results,
            totalCost: totalApprovedCost, // Keep for internal use, NOT displayed
            averagePercentage,
            topStore,
            topPercentage,
            storeCount: storeCountWithCost
        };
    }

    // ================================
    // COMPLIANCE CHART - % OF DAYS REPORTED (CURRENT MONTH)
    // ================================
    function updateComplianceChart() {
        if (!currentData) return;
        
        const ctx = document.getElementById('complianceChart');
        if (!ctx) return;
        
        // Destroy existing chart
        if (complianceChart) {
            complianceChart.destroy();
        }
        
        const data = currentData.compliance;
        
        if (data.results.length === 0) {
            createEmptyComplianceChart();
            return;
        }
        
        // Show ALL stores with compliance data
        const displayResults = data.results;
        
        const labels = displayResults.map(store => store.displayName);
        const values = displayResults.map(store => store.value);
        const colors = CHART_COLORS.slice(0, displayResults.length);
        
        const datasets = [{
            label: 'Compliance Rate (%)',
            data: values,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 1,
            hoverOffset: 6
        }];
        
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: currentComplianceChartType === 'pie',
                    position: 'right',
                    labels: {
                        boxWidth: 10,
                        font: { size: 10 },
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const store = displayResults[context.dataIndex];
                            return `${store.displayName}: ${store.value}% (${store.reportedDays}/${store.totalDays} days)`;
                        }
                    }
                }
            },
            animation: {
                duration: 600
            }
        };
        
        let chartConfig;
        
        if (currentComplianceChartType === 'bar') {
            chartConfig = {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: { size: 9 }
                            },
                            title: {
                                display: true,
                                text: 'Compliance Rate (%)',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            };
        } else {
            chartConfig = {
                type: 'pie',
                data: { labels, datasets },
                options: {
                    ...commonOptions,
                    cutout: '0%',
                    radius: '85%'
                }
            };
        }
        
        complianceChart = new Chart(ctx, chartConfig);
        
        // Update footer stats
        document.getElementById('complianceStoreCount').textContent = `${data.storeCount} stores`;
        document.getElementById('complianceAverage').textContent = `${data.overallAverage}% avg`;
        document.getElementById('complianceDays').textContent = `${data.month} (${data.daysSoFar} days)`;
        document.getElementById('currentMonthDisplay').textContent = `ðŸ“… Currently showing: ${data.month}`;
        
        // Update combined stats
        updateCombinedStats();
    }

    // ================================
    // COST CHART - PERCENTAGE SHARE (CURRENT MONTH)
    // ================================
    function updateCostChart() {
        if (!currentData) return;
        
        const ctx = document.getElementById('costChart');
        if (!ctx) return;
        
        // Destroy existing chart
        if (costChart) {
            costChart.destroy();
        }
        
        const data = currentData.cost;
        
        console.log('ðŸ“Š Updating cost share chart (Current Month):', {
            resultsCount: data.results.length,
            results: data.results.map(r => ({ 
                store: r.store, 
                percentage: r.percentage,
                displayName: r.displayName 
            }))
        });
        
        if (data.results.length === 0) {
            createEmptyCostChart();
            return;
        }
        
        // Show ALL stores with cost data from current month
        const displayResults = data.results;
        
        const labels = displayResults.map(store => store.displayName);
        const values = displayResults.map(store => store.percentage); // PERCENTAGES
        const colors = CHART_COLORS.slice(0, displayResults.length);
        
        const datasets = [{
            label: 'Waste Cost Share (%)',
            data: values,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 1,
            hoverOffset: 6
        }];
        
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: currentCostChartType === 'pie',
                    position: 'right',
                    labels: {
                        boxWidth: 10,
                        font: { size: 10 },
                        padding: 10
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const store = displayResults[context.dataIndex];
                            return `${store.displayName}: ${store.percentage}% of total waste cost (This Month)`;
                        }
                    }
                }
            },
            animation: {
                duration: 600
            }
        };
        
        let chartConfig;
        
        if (currentCostChartType === 'bar') {
            chartConfig = {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: { size: 9 }
                            },
                            title: {
                                display: true,
                                text: 'Waste Cost Share (%)',
                                font: { size: 10 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { 
                                font: { size: 9 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            };
        } else {
            chartConfig = {
                type: 'pie',
                data: { labels, datasets },
                options: {
                    ...commonOptions,
                    cutout: '0%',
                    radius: '85%'
                }
            };
        }
        
        costChart = new Chart(ctx, chartConfig);
        
        // Update footer stats - SHOW PERCENTAGES ONLY
        document.getElementById('costStoreCount').textContent = `${data.storeCount} stores`;
        document.getElementById('costAverage').textContent = `${data.averagePercentage}% avg share`;
        document.getElementById('totalWasteCost').textContent = `100% total`;
        
        // Update combined stats
        updateCombinedStats();
    }

    // ================================
    // EMPTY CHARTS
    // ================================
    function createEmptyCharts() {
        createEmptyComplianceChart();
        createEmptyCostChart();
    }

    function createEmptyComplianceChart() {
        const ctx = document.getElementById('complianceChart');
        if (!ctx) return;
        if (complianceChart) complianceChart.destroy();
        
        complianceChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['No Reports This Month'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e9ecef'],
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
        
        document.getElementById('complianceStoreCount').textContent = '0 stores';
        document.getElementById('complianceAverage').textContent = '0% avg';
        document.getElementById('complianceDays').textContent = 'Current month';
        document.getElementById('currentMonthDisplay').textContent = `ðŸ“… Currently showing: ${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
    }

    function createEmptyCostChart() {
        const ctx = document.getElementById('costChart');
        if (!ctx) return;
        if (costChart) costChart.destroy();
        
        costChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['No Waste This Month'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e9ecef'],
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
        
        document.getElementById('costStoreCount').textContent = '0 stores';
        document.getElementById('costAverage').textContent = '0% avg share';
        document.getElementById('totalWasteCost').textContent = '100% total';
    }

    // ================================
    // STATISTICS FUNCTIONS
    // ================================
    function updateCombinedStats() {
        if (!currentData) return;
        
        const complianceData = currentData.compliance;
        const costData = currentData.cost;
        
        // Top compliance store
        document.getElementById('topComplianceStore').textContent = complianceData.topStore ? 
            STORE_DISPLAY_NAMES[complianceData.topStore]?.split(' ')[0] || complianceData.topStore : '-';
        document.getElementById('topComplianceValue').textContent = `${complianceData.topValue}%`;
        
        // Overall compliance average
        document.getElementById('overallComplianceAvg').textContent = `${complianceData.overallAverage}%`;
        
        // Top cost share store
        document.getElementById('topCostStore').textContent = costData.topStore ? 
            STORE_DISPLAY_NAMES[costData.topStore]?.split(' ')[0] || costData.topStore : '-';
        document.getElementById('topCostValue').textContent = `${costData.topPercentage || 0}%`;
        
        // Stores with waste cost this month
        document.getElementById('overallCostTotal').textContent = costData.storeCount || 0;
    }

    function updateStats() {
        if (!currentData) return;
        
        const complianceData = currentData.compliance;
        const costData = currentData.cost;
        
        // Total reports this month
        document.getElementById('totalReports').textContent = complianceData.results.reduce((sum, store) => sum + store.totalReports, 0).toLocaleString();
        document.getElementById('totalStoresWithReports').textContent = `${complianceData.storeCount} stores`;
        
        // Store needing attention (lowest compliance among stores with reports)
        if (complianceData.results.length > 0) {
            const needsAttentionStore = complianceData.results[complianceData.results.length - 1];
            document.getElementById('needsAttention').textContent = 
                STORE_DISPLAY_NAMES[needsAttentionStore.store]?.split(' ')[0] || needsAttentionStore.store;
            document.getElementById('attentionReason').textContent = `${needsAttentionStore.value}% compliance`;
        } else {
            document.getElementById('needsAttention').textContent = '-';
            document.getElementById('attentionReason').textContent = 'No reports';
        }
        
        // Update time
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('lastUpdatedTime').textContent = timeString;
        
        // Update combined stats
        updateCombinedStats();
    }

    function updateEmptyStats() {
        document.getElementById('totalReports').textContent = '0';
        document.getElementById('totalStoresWithReports').textContent = '0 stores';
        document.getElementById('needsAttention').textContent = '-';
        document.getElementById('attentionReason').textContent = 'No reports';
        
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('lastUpdatedTime').textContent = timeString;
        
        // Reset combined stats
        document.getElementById('topComplianceStore').textContent = '-';
        document.getElementById('topComplianceValue').textContent = '0%';
        document.getElementById('overallComplianceAvg').textContent = '0%';
        document.getElementById('topCostStore').textContent = '-';
        document.getElementById('topCostValue').textContent = '0%';
        document.getElementById('overallCostTotal').textContent = '0';
    }

    // ================================
    // EVENT HANDLERS
    // ================================
    function setupEventListeners() {
        // Compliance chart type buttons
        document.querySelectorAll('[data-chart^="compliance-"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartType = this.dataset.chart.split('-')[1];
                document.querySelectorAll('[data-chart^="compliance-"]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentComplianceChartType = chartType;
                updateComplianceChart();
            });
        });
        
        // Cost chart type buttons
        document.querySelectorAll('[data-chart^="cost-"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartType = this.dataset.chart.split('-')[1];
                document.querySelectorAll('[data-chart^="cost-"]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCostChartType = chartType;
                updateCostChart();
            });
        });
        
        // Double-click to refresh
        document.querySelectorAll('.chart-card').forEach(card => {
            card.addEventListener('dblclick', function() {
                dataCache.timestamp = 0;
                loadAllData();
                showNotification('Chart data refreshed', 'info');
            });
        });
    }

    // ================================
    // INITIALIZATION
    // ================================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Home page loaded, initializing charts...');
        initializeFirebase();
        setTimeout(setupEventListeners, 100);
        
        // Refresh every 5 minutes
        setInterval(() => {
            dataCache.timestamp = 0;
            loadAllData();
        }, 5 * 60 * 1000);
    });
    </script>
</body>
</html>