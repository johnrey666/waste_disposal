<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FG Operations Waste/Disposal Reporting</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Additional styles for dual chart layout */
        .dual-chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
        }
        
        .chart-card {
            background: var(--color-white);
            border-radius: var(--border-radius);
            border: var(--border-base);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            height: 100%;
            transition: all var(--transition-fast);
        }
        
        .chart-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .chart-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: var(--border-thin);
        }
        
        .chart-card-header h3 {
            color: var(--color-primary);
            font-size: var(--font-size-md);
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .chart-card-type-selector {
            display: flex;
            gap: 4px;
            background: var(--color-offwhite);
            border-radius: var(--border-radius-sm);
            padding: 2px;
            border: var(--border-thin);
        }
        
        .chart-card-type-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: var(--font-size-xs);
            color: var(--color-gray);
            transition: all var(--transition-fast);
        }
        
        .chart-card-type-btn:hover {
            color: var(--color-primary);
            background: rgba(42, 89, 52, 0.1);
        }
        
        .chart-card-type-btn.active {
            background: var(--color-primary);
            color: white;
        }
        
        .chart-card-body {
            flex: 1;
            position: relative;
            min-height: 300px;
        }
        
        .chart-card-footer {
            margin-top: var(--spacing-md);
            padding-top: var(--spacing-sm);
            border-top: var(--border-thin);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: var(--font-size-xs);
            color: var(--color-gray);
        }
        
        .chart-card-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .chart-card-stat i {
            color: var(--color-primary);
        }
        
        @media (max-width: 992px) {
            .dual-chart-container {
                grid-template-columns: 1fr;
                gap: var(--spacing-md);
            }
            
            .chart-card-body {
                min-height: 250px;
            }
        }
        
        @media (max-width: 768px) {
            .chart-card-body {
                min-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification" class="notification"></div>
    
    <div class="container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="nav-brand">
                <img src="logo.jpg" alt="FG Operations Logo" class="nav-logo">
                <span>FG Operations</span>
            </div>
            <ul class="nav-links">
                <li><a href="index.html" class="active">Home</a></li>
                <li><a href="submit_waste_report.html">Report Waste</a></li>
                <li><a href="waste_report_table.html">View Reports</a></li>
            </ul>
            <div class="nav-actions">
                <button class="btn btn-primary" onclick="window.location.href='submit_waste_report.html'">
                    <i class="fas fa-plus"></i> Submit Report
                </button>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero">
            <div class="hero-content">
                <h1>FG Operations Waste/Disposal Reporting</h1>
                <p class="subtitle">Daily Reporting System</p>
                <p>Submit daily reports for expired items and waste, or view previously submitted reports.</p></br>
                <div class="hero-buttons">
                    <button class="btn btn-primary btn-large" onclick="window.location.href='submit_waste_report.html'">
                        <i class="fas fa-file-alt"></i> Submit Waste Report
                    </button>
                    <button class="btn btn-secondary btn-large" onclick="window.location.href='waste_report_table.html'">
                        <i class="fas fa-list"></i> View Reports
                    </button>
                </div>
            </div>
        </section>

        <!-- Dual Charts Section -->
        <section class="chart-section">
            <div class="chart-header">
                <h2><i class="fas fa-chart-bar"></i> Waste & Compliance Analytics</h2>
            </div>

            <!-- Dual Chart Container -->
            <div class="dual-chart-container">
                <!-- Compliance Rate Chart Card -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3><i class="fas fa-check-circle" style="color: #28a745;"></i> Compliance Rate</h3>
                        <div class="chart-card-type-selector">
                            <button class="chart-card-type-btn active" data-chart="compliance-pie" data-metric="compliance">
                                <i class="fas fa-chart-pie"></i>
                            </button>
                            <button class="chart-card-type-btn" data-chart="compliance-bar" data-metric="compliance">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-card-body">
                        <canvas id="complianceChart"></canvas>
                    </div>
                    <div class="chart-card-footer">
                        <div class="chart-card-stat">
                            <i class="fas fa-store"></i>
                            <span id="complianceStoreCount">0 stores</span>
                        </div>
                        <div class="chart-card-stat">
                            <i class="fas fa-chart-line"></i>
                            <span id="complianceAverage">0% avg</span>
                        </div>
                    </div>
                </div>

                <!-- Waste Cost Rate Chart Card -->
                <div class="chart-card">
                    <div class="chart-card-header">
                        <h3><i class="fas fa-money-bill-wave" style="color: #dc3545;"></i> Waste Cost Share</h3>
                        <div class="chart-card-type-selector">
                            <button class="chart-card-type-btn active" data-chart="cost-pie" data-metric="cost">
                                <i class="fas fa-chart-pie"></i>
                            </button>
                            <button class="chart-card-type-btn" data-chart="cost-bar" data-metric="cost">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="chart-card-body">
                        <canvas id="costChart"></canvas>
                    </div>
                    <div class="chart-card-footer">
                        <div class="chart-card-stat">
                            <i class="fas fa-store"></i>
                            <span id="costStoreCount">0 stores</span>
                        </div>
                        <div class="chart-card-stat">
                            <i class="fas fa-chart-line"></i>
                            <span id="costAverage">0% avg</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Combined Chart Statistics -->
            <div class="chart-stats">
                <div class="chart-stat-card">
                    <h4><i class="fas fa-store"></i> Top Compliance</h4>
                    <div class="value" id="topComplianceStore">-</div>
                    <div class="subtext" id="topComplianceValue">0%</div>
                </div>
                
                <div class="chart-stat-card">
                    <h4><i class="fas fa-chart-line"></i> Avg Compliance</h4>
                    <div class="value" id="overallComplianceAvg">0%</div>
                    <div class="subtext">All Stores</div>
                </div>
                
                <div class="chart-stat-card">
                    <h4><i class="fas fa-money-bill-wave"></i> Highest Cost</h4>
                    <div class="value" id="topCostStore">-</div>
                    <div class="subtext" id="topCostValue">0%</div>
                </div>
                
                <div class="chart-stat-card">
                    <h4><i class="fas fa-chart-line"></i> Avg Cost Share</h4>
                    <div class="value" id="overallCostAvg">0%</div>
                    <div class="subtext">All Stores</div>
                </div>
            </div>
            
            <!-- Chart Footer -->
            <div class="chart-footer">
                <div class="chart-info">
                    <i class="fas fa-info-circle"></i> Click on chart segments for details. Compliance rate shows reporting frequency, cost share shows waste expense distribution.
                </div>
            </div>
        </section>

        <!-- Quick Stats Section -->
        <section class="quick-stats-section">
            <h2><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
            <div class="stat-grid">
                <div class="quick-stat-card">
                    <div class="stat-icon-mini">
                        <i class="fas fa-store"></i>
                    </div>
                    <div class="stat-content-mini">
                        <h4>Total Stores</h4>
                        <div class="value-large">12</div>
                        <div class="subtext">Active locations</div>
                    </div>
                </div>
                
                <div class="quick-stat-card">
                    <div class="stat-icon-mini">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-content-mini">
                        <h4>Total Reports</h4>
                        <div class="value-large" id="totalReports">0</div>
                        <div class="subtext" id="totalStoresWithReports">0 stores</div>
                    </div>
                </div>
                
                <div class="quick-stat-card">
                    <div class="stat-icon-mini">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content-mini">
                        <h4>Needs Attention</h4>
                        <div class="value-large" id="needsAttention">-</div>
                        <div class="subtext" id="attentionReason">Low compliance</div>
                    </div>
                </div>
                
                <div class="quick-stat-card">
                    <div class="stat-icon-mini">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="stat-content-mini">
                        <h4>Updated</h4>
                        <div class="value-large" id="lastUpdatedTime">-</div>
                        <div class="subtext">Just now</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Store Locations -->
        <section class="features">
            <h2><i class="fas fa-map-marker-alt"></i> Available Store Locations</h2>
            <div class="store-grid">
                <div class="store-card">
                    <h3>FG Express Stores</h3>
                    <ul class="store-list">
                        <li>FG Express IROSIN</li>
                        <li>FG Express LIGAO</li>
                        <li>FG Express POLANGUI</li>
                        <li>FG Express MASBATE</li>
                        <li>FG Express DARAGA</li>
                        <li>FG Express BAAO</li>
                        <li>FG Express PIODURAN</li>
                        <li>FG Express RIZAL</li>
                    </ul>
                </div>
                <div class="store-card">
                    <h3>FG to go & Main Stores</h3>
                    <ul class="store-list">
                        <li>FG to go TABACO</li>
                        <li>FG to go LEGAZPI</li>
                        <li>FG LEGAZPI</li>
                        <li>FG NAGA</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-brand">
                    <img src="logo.jpg" alt="FG Operations Logo" class="footer-logo">
                    <span>FG Operations Waste/Disposal Reporting System v1.0</span>
                </div>
                <div class="footer-links">
                    <a href="index.html"><i class="fas fa-home"></i> Home</a>
                    <a href="submit_waste_report.html"><i class="fas fa-file-alt"></i> Submit Report</a>
                    <a href="waste_report_table.html"><i class="fas fa-list"></i> View Reports</a>
                </div>
                <p class="copyright">This form was created as a standalone HTML version with Firebase backend.</p>
            </div>
        </footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
    // ================================
    // CONFIGURATION
    // ================================

    // Firestore configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAyp2f1b6cG4E_Dx9eako31LgTDuZrZ8_E",
        authDomain: "disposal-e6b83.firebaseapp.com",
        projectId: "disposal-e6b83",
        storageBucket: "disposal-e6b83.firebasestorage.app",
        messagingSenderId: "1050986320678",
        appId: "1:1050986320678:web:deb5f4c58c3ef0cbc6a7e7",
        measurementId: "G-3Q7705T5FE"
    };

    // ================================
    // GLOBAL VARIABLES
    // ================================
    let db;
    let complianceChart = null;
    let costChart = null;
    let currentComplianceChartType = 'pie';
    let currentCostChartType = 'pie';
    let currentData = null;

    // Define all store names
    const ALL_STORES = [
        'FG Express IROSIN',
        'FG Express LIGAO',
        'FG Express POLANGUI',
        'FG Express MASBATE',
        'FG Express DARAGA',
        'FG Express BAAO',
        'FG Express PIODURAN',
        'FG Express RIZAL',
        'FG to go TABACO',
        'FG to go LEGAZPI',
        'FG LEGAZPI',
        'FG NAGA'
    ];

    // Store display names for chart
    const STORE_DISPLAY_NAMES = {
        'FG Express IROSIN': 'IROSIN',
        'FG Express LIGAO': 'LIGAO',
        'FG Express POLANGUI': 'POLANGUI',
        'FG Express MASBATE': 'MASBATE',
        'FG Express DARAGA': 'DARAGA',
        'FG Express BAAO': 'BAAO',
        'FG Express PIODURAN': 'PIODURAN',
        'FG Express RIZAL': 'RIZAL',
        'FG to go TABACO': 'TABACO',
        'FG to go LEGAZPI': 'LEGAZPI (to go)',
        'FG LEGAZPI': 'LEGAZPI',
        'FG NAGA': 'NAGA'
    };

    // Colors for charts
    const CHART_COLORS = [
        '#28a745', '#20c997', '#17a2b8', '#0dcaf0',
        '#ffc107', '#fd7e14', '#dc3545', '#6c757d',
        '#6610f2', '#6f42c1', '#d63384', '#198754'
    ];

    // ================================
    // LOADING & NOTIFICATION
    // ================================
    function showNotification(message, type = 'success', duration = 3000) {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        if (notification.timeoutId) {
            clearTimeout(notification.timeoutId);
        }
        
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = 'block';
        notification.style.animation = 'slideInRight 0.3s ease';
        
        notification.timeoutId = setTimeout(() => {
            notification.style.animation = 'fadeOut 0.3s ease';
            setTimeout(() => {
                notification.style.display = 'none';
                notification.style.animation = '';
            }, 300);
        }, duration);
        
        return notification;
    }

    function showLoading(show, message = 'Loading...') {
        const overlay = document.getElementById('loadingOverlay');
        if (!overlay) return;
        
        requestAnimationFrame(() => {
            overlay.style.display = show ? 'flex' : 'none';
            if (show && message !== 'Loading...') {
                const spinner = overlay.querySelector('.loading-spinner');
                if (spinner) {
                    spinner.style.marginBottom = '15px';
                    spinner.nextElementSibling?.remove();
                    const text = document.createElement('p');
                    text.textContent = message;
                    text.style.cssText = 'color: white; margin: 0; font-size: 14px; text-align: center;';
                    overlay.appendChild(text);
                }
            }
        });
    }

    // ================================
    // FIREBASE INITIALIZATION
    // ================================
    function initializeFirebase() {
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            
            // Enable offline persistence for better performance
            db.enablePersistence()
                .then(() => console.log('✅ Firebase persistence enabled'))
                .catch(err => {
                    if (err.code === 'failed-precondition') {
                        console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code === 'unimplemented') {
                        console.log('The current browser does not support persistence.');
                    }
                });
            
            // Load all data
            loadAllData();
            
        } catch (error) {
            console.error('❌ Firebase initialization error:', error);
            showNotification('Firebase connection failed. Please check console.', 'error');
        }
    }

    // ================================
    // DATA LOADING FUNCTIONS
    // ================================
    async function loadAllData() {
        showLoading(true, 'Loading store statistics...');
        
        try {
            // Get all reports
            const snapshot = await db.collection('wasteReports')
                .orderBy('reportDate', 'desc')
                .get();
            
            if (snapshot.empty) {
                // No reports yet
                createEmptyCharts();
                updateEmptyStats();
                showLoading(false);
                return;
            }
            
            // Process all reports
            const reports = [];
            snapshot.forEach(doc => {
                reports.push({ id: doc.id, ...doc.data() });
            });
            
            // Calculate compliance data
            const complianceData = calculateComplianceData(reports);
            
            // Calculate cost data
            const costData = calculateCostData(reports);
            
            // Store data globally
            currentData = {
                compliance: complianceData,
                cost: costData,
                totalReports: reports.length
            };
            
            // Update both charts
            updateComplianceChart();
            updateCostChart();
            
            // Update statistics
            updateStats();
            
        } catch (error) {
            console.error('Error loading data:', error);
            showNotification('Error loading data', 'error');
            createEmptyCharts();
        } finally {
            showLoading(false);
        }
    }

    function calculateComplianceData(reports) {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const currentDay = now.getDate();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const daysSoFar = Math.min(currentDay, daysInMonth);
        
        // Initialize store data
        const storeData = {};
        ALL_STORES.forEach(store => {
            storeData[store] = {
                reportedDays: new Set(),
                totalReports: 0
            };
        });
        
        // Process reports for current month
        reports.forEach(report => {
            const store = report.store;
            const reportDate = new Date(report.reportDate);
            
            if (store && storeData[store]) {
                storeData[store].totalReports++;
                
                // Check if report is from current month
                if (reportDate.getFullYear() === currentYear && 
                    reportDate.getMonth() === currentMonth &&
                    reportDate.getDate() <= currentDay) {
                    storeData[store].reportedDays.add(reportDate.getDate());
                }
            }
        });
        
        // Calculate compliance percentages
        const results = [];
        let totalCompliance = 0;
        let storeCount = 0;
        let topStore = null;
        let topValue = 0;
        let lowestStore = null;
        let lowestValue = 100;
        
        for (const [store, data] of Object.entries(storeData)) {
            if (data.totalReports === 0) continue; // Skip stores with no reports at all
            
            const reportedDays = data.reportedDays.size;
            const complianceRate = daysSoFar > 0 ? 
                Math.round((reportedDays / daysSoFar) * 100) : 0;
            
            results.push({
                store,
                displayName: STORE_DISPLAY_NAMES[store] || store,
                value: complianceRate,
                reportedDays,
                totalDays: daysSoFar,
                label: `${complianceRate}%`,
                description: `${reportedDays}/${daysSoFar} days`
            });
            
            totalCompliance += complianceRate;
            storeCount++;
            
            if (complianceRate > topValue) {
                topValue = complianceRate;
                topStore = store;
            }
            
            if (complianceRate < lowestValue) {
                lowestValue = complianceRate;
                lowestStore = store;
            }
        }
        
        // Calculate overall average
        const overallAverage = storeCount > 0 ? Math.round(totalCompliance / storeCount) : 0;
        
        // Calculate coverage (percentage of stores with any reports)
        const coverage = Math.round((storeCount / ALL_STORES.length) * 100);
        
        return {
            results,
            overallAverage,
            topStore,
            topValue,
            lowestStore,
            lowestValue,
            storeCount,
            coverage,
            metricName: 'Compliance Rate',
            unit: '%',
            tooltipLabel: 'compliance'
        };
    }

    function calculateCostData(reports) {
        // Calculate total cost per store
        const storeCosts = {};
        let totalCost = 0;
        
        ALL_STORES.forEach(store => {
            storeCosts[store] = 0;
        });
        
        reports.forEach(report => {
            const store = report.store;
            if (!store || !storeCosts.hasOwnProperty(store)) return;
            
            // Skip no-waste reports
            if (report.disposalTypes?.includes('noWaste') || report.disposalType === 'noWaste') {
                return;
            }
            
            // Calculate cost from expired items
            if (report.expiredItems) {
                report.expiredItems.forEach(item => {
                    const itemCost = item.itemCost || 0;
                    const quantity = item.quantity || 0;
                    storeCosts[store] += itemCost * quantity;
                });
            }
            
            // Calculate cost from waste items
            if (report.wasteItems) {
                report.wasteItems.forEach(item => {
                    const itemCost = item.itemCost || 0;
                    const quantity = item.quantity || 0;
                    storeCosts[store] += itemCost * quantity;
                });
            }
        });
        
        // Calculate total cost
        totalCost = Object.values(storeCosts).reduce((sum, cost) => sum + cost, 0);
        
        // Calculate percentages and prepare data
        const results = [];
        let topStore = null;
        let topValue = 0;
        let lowestStore = null;
        let lowestValue = 100;
        let storeCount = 0;
        let totalPercentage = 0;
        
        for (const [store, cost] of Object.entries(storeCosts)) {
            if (cost === 0) continue;
            
            const percentage = totalCost > 0 ? Math.round((cost / totalCost) * 100) : 0;
            
            results.push({
                store,
                displayName: STORE_DISPLAY_NAMES[store] || store,
                value: percentage,
                cost: cost,
                label: `${percentage}%`,
                description: `₱${cost.toLocaleString()}`
            });
            
            totalPercentage += percentage;
            storeCount++;
            
            if (percentage > topValue) {
                topValue = percentage;
                topStore = store;
            }
            
            if (percentage < lowestValue && percentage > 0) {
                lowestValue = percentage;
                lowestStore = store;
            }
        }
        
        // Calculate overall average
        const overallAverage = storeCount > 0 ? Math.round(totalPercentage / storeCount) : 0;
        
        // Calculate coverage (percentage of stores with waste cost)
        const coverage = Math.round((storeCount / ALL_STORES.length) * 100);
        
        return {
            results,
            overallAverage,
            topStore,
            topValue,
            lowestStore,
            lowestValue,
            storeCount,
            coverage,
            metricName: 'Waste Cost Share',
            unit: '%',
            tooltipLabel: 'waste share'
        };
    }

    // ================================
    // CHART FUNCTIONS
    // ================================
    function updateComplianceChart() {
        if (!currentData) return;
        
        const ctx = document.getElementById('complianceChart');
        
        // Destroy existing chart
        if (complianceChart) {
            complianceChart.destroy();
        }
        
        // Get compliance data
        const data = currentData.compliance;
        
        // Sort data highest first for compliance
        let sortedResults = [...data.results];
        sortedResults.sort((a, b) => b.value - a.value);
        
        // Take top 6 stores for better visibility
        const displayResults = sortedResults.slice(0, 6);
        
        if (displayResults.length === 0) {
            createEmptyComplianceChart();
            return;
        }
        
        // Prepare data
        const labels = displayResults.map(store => store.displayName);
        const values = displayResults.map(store => store.value);
        const colors = CHART_COLORS.slice(0, displayResults.length);
        
        // Create chart based on selected type
        const chartConfig = getChartConfig(currentComplianceChartType, labels, values, colors, data);
        
        complianceChart = new Chart(ctx, chartConfig);
        
        // Update compliance chart footer stats
        document.getElementById('complianceStoreCount').textContent = `${data.storeCount} stores`;
        document.getElementById('complianceAverage').textContent = `${data.overallAverage}% avg`;
        
        // Update combined stats
        updateCombinedStats();
    }

    function updateCostChart() {
        if (!currentData) return;
        
        const ctx = document.getElementById('costChart');
        
        // Destroy existing chart
        if (costChart) {
            costChart.destroy();
        }
        
        // Get cost data
        const data = currentData.cost;
        
        // Sort data highest first for cost
        let sortedResults = [...data.results];
        sortedResults.sort((a, b) => b.value - a.value);
        
        // Take top 6 stores for better visibility
        const displayResults = sortedResults.slice(0, 6);
        
        if (displayResults.length === 0) {
            createEmptyCostChart();
            return;
        }
        
        // Prepare data
        const labels = displayResults.map(store => store.displayName);
        const values = displayResults.map(store => store.value);
        const colors = CHART_COLORS.slice(0, displayResults.length);
        
        // Create chart based on selected type
        const chartConfig = getChartConfig(currentCostChartType, labels, values, colors, data);
        
        costChart = new Chart(ctx, chartConfig);
        
        // Update cost chart footer stats
        document.getElementById('costStoreCount').textContent = `${data.storeCount} stores`;
        document.getElementById('costAverage').textContent = `${data.overallAverage}% avg`;
        
        // Update combined stats
        updateCombinedStats();
    }

    function getChartConfig(type, labels, values, colors, data) {
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: type === 'pie',
                    position: 'right',
                    labels: {
                        boxWidth: 10,
                        font: { size: 10 },
                        padding: 10
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                    titleFont: { size: 11 },
                    bodyFont: { size: 10 },
                    padding: 8,
                    cornerRadius: 4,
                    displayColors: type === 'pie',
                    callbacks: {
                        label: function(context) {
                            const store = data.results.find(s => 
                                s.displayName === context.label || 
                                s.value === context.raw
                            );
                            if (store) {
                                if (data.metricName === 'Compliance Rate') {
                                    return `${data.metricName}: ${store.value}${data.unit} (${store.reportedDays}/${store.totalDays} days)`;
                                } else {
                                    return `${data.metricName}: ${store.value}${data.unit} (₱${store.cost?.toLocaleString() || 0})`;
                                }
                            }
                            return `${context.dataset.label}: ${context.raw}${data.unit}`;
                        }
                    }
                }
            },
            animation: {
                duration: 600
            }
        };

        const datasets = [{
            label: data.metricName,
            data: values,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 1,
            hoverOffset: 6
        }];

        if (type === 'bar') {
            return {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    ...commonOptions,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + data.unit;
                                },
                                font: { size: 9 }
                            },
                            title: {
                                display: true,
                                text: data.metricName,
                                font: { size: 10 }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 9 } }
                        }
                    }
                }
            };
        } else { // pie chart
            return {
                type: 'pie',
                data: { labels, datasets },
                options: {
                    ...commonOptions,
                    cutout: '0%',
                    radius: '85%'
                }
            };
        }
    }

    function createEmptyCharts() {
        createEmptyComplianceChart();
        createEmptyCostChart();
    }

    function createEmptyComplianceChart() {
        const ctx = document.getElementById('complianceChart');
        if (complianceChart) complianceChart.destroy();
        
        complianceChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['No Data Available'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e9ecef'],
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
        
        document.getElementById('complianceStoreCount').textContent = '0 stores';
        document.getElementById('complianceAverage').textContent = '0% avg';
    }

    function createEmptyCostChart() {
        const ctx = document.getElementById('costChart');
        if (costChart) costChart.destroy();
        
        costChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['No Data Available'],
                datasets: [{
                    data: [1],
                    backgroundColor: ['#e9ecef'],
                    borderColor: '#fff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
        
        document.getElementById('costStoreCount').textContent = '0 stores';
        document.getElementById('costAverage').textContent = '0% avg';
    }

    // ================================
    // STATISTICS FUNCTIONS
    // ================================
    function updateCombinedStats() {
        if (!currentData) return;
        
        const complianceData = currentData.compliance;
        const costData = currentData.cost;
        
        // Update top compliance store
        document.getElementById('topComplianceStore').textContent = complianceData.topStore ? 
            STORE_DISPLAY_NAMES[complianceData.topStore]?.split(' ')[0] || complianceData.topStore : '-';
        document.getElementById('topComplianceValue').textContent = `${complianceData.topValue}%`;
        
        // Update overall compliance average
        document.getElementById('overallComplianceAvg').textContent = `${complianceData.overallAverage}%`;
        
        // Update top cost store
        document.getElementById('topCostStore').textContent = costData.topStore ? 
            STORE_DISPLAY_NAMES[costData.topStore]?.split(' ')[0] || costData.topStore : '-';
        document.getElementById('topCostValue').textContent = `${costData.topValue}%`;
        
        // Update overall cost average
        document.getElementById('overallCostAvg').textContent = `${costData.overallAverage}%`;
    }

    function updateStats() {
        if (!currentData) return;
        
        const complianceData = currentData.compliance;
        
        // Update quick stats
        document.getElementById('totalReports').textContent = currentData.totalReports;
        document.getElementById('totalStoresWithReports').textContent = `${complianceData.storeCount} stores`;
        
        // Find store needing attention (lowest compliance with reports)
        const storesWithReports = complianceData.results.filter(store => store.value > 0);
        if (storesWithReports.length > 0) {
            const needsAttentionStore = storesWithReports[storesWithReports.length - 1];
            document.getElementById('needsAttention').textContent = 
                STORE_DISPLAY_NAMES[needsAttentionStore.store]?.split(' ')[0] || needsAttentionStore.store;
            document.getElementById('attentionReason').textContent = `${needsAttentionStore.value}% compliance`;
        } else {
            document.getElementById('needsAttention').textContent = '-';
            document.getElementById('attentionReason').textContent = 'No reports';
        }
        
        // Update time
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('lastUpdatedTime').textContent = timeString;
        
        // Update combined stats
        updateCombinedStats();
    }

    function updateEmptyStats() {
        document.getElementById('totalReports').textContent = '0';
        document.getElementById('totalStoresWithReports').textContent = '0 stores';
        document.getElementById('needsAttention').textContent = '-';
        document.getElementById('attentionReason').textContent = 'No reports';
        
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('lastUpdatedTime').textContent = timeString;
        
        // Reset combined stats
        document.getElementById('topComplianceStore').textContent = '-';
        document.getElementById('topComplianceValue').textContent = '0%';
        document.getElementById('overallComplianceAvg').textContent = '0%';
        document.getElementById('topCostStore').textContent = '-';
        document.getElementById('topCostValue').textContent = '0%';
        document.getElementById('overallCostAvg').textContent = '0%';
    }

    // ================================
    // EVENT HANDLERS
    // ================================
    function setupEventListeners() {
        // Compliance chart type buttons
        document.querySelectorAll('[data-chart^="compliance-"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartType = this.dataset.chart.split('-')[1]; // Get 'pie' or 'bar'
                document.querySelectorAll('[data-chart^="compliance-"]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentComplianceChartType = chartType;
                updateComplianceChart();
            });
        });
        
        // Cost chart type buttons
        document.querySelectorAll('[data-chart^="cost-"]').forEach(btn => {
            btn.addEventListener('click', function() {
                const chartType = this.dataset.chart.split('-')[1]; // Get 'pie' or 'bar'
                document.querySelectorAll('[data-chart^="cost-"]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentCostChartType = chartType;
                updateCostChart();
            });
        });
        
        // Refresh functionality (click on any chart card)
        document.querySelectorAll('.chart-card').forEach(card => {
            card.addEventListener('dblclick', function() {
                loadAllData();
                showNotification('Chart data refreshed', 'info');
            });
        });
    }

    // ================================
    // INITIALIZATION
    // ================================
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Home page loaded, initializing charts...');
        initializeFirebase();
        setupEventListeners();
        
        // Add CSS for enhanced UI
        addEnhancedStyles();
        
        // Refresh data every 10 minutes
        setInterval(loadAllData, 10 * 60 * 1000);
    });

    function addEnhancedStyles() {
        // Check if styles already exist
        if (document.getElementById('enhanced-styles')) return;
        
        // Add inline styles for enhanced UI
        const style = document.createElement('style');
        style.id = 'enhanced-styles';
        style.textContent = `
            /* Quick Stats Section */
            .quick-stats-section {
                margin: var(--spacing-xl) 0;
                background: var(--color-white);
                border-radius: var(--border-radius);
                box-shadow: var(--shadow-sm);
                padding: var(--spacing-lg);
                border: var(--border-base);
            }
            
            .quick-stats-section h2 {
                color: var(--color-primary);
                margin-bottom: var(--spacing-lg);
                font-size: var(--font-size-lg);
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            }
            
            .stat-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
            }
            
            .quick-stat-card {
                display: flex;
                align-items: center;
                gap: var(--spacing-md);
                padding: var(--spacing-md);
                background: var(--color-offwhite);
                border-radius: var(--border-radius);
                border: var(--border-thin);
                transition: all var(--transition-fast);
                position: relative;
                overflow: hidden;
                height: 100%;
            }
            
            .quick-stat-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
                border-color: var(--color-primary);
            }
            
            .quick-stat-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                width: 4px;
                height: 100%;
                background: var(--color-primary);
                opacity: 0;
                transition: opacity var(--transition-fast);
            }
            
            .quick-stat-card:hover::before {
                opacity: 1;
            }
            
            .stat-icon-mini {
                width: 40px;
                height: 40px;
                border-radius: var(--border-radius);
                display: flex;
                align-items: center;
                justify-content: center;
                color: var(--color-white);
                background: var(--color-primary);
                font-size: var(--font-size-md);
                flex-shrink: 0;
                transition: transform var(--transition-fast);
            }
            
            .quick-stat-card:hover .stat-icon-mini {
                transform: scale(1.1);
            }
            
            .stat-content-mini {
                flex: 1;
                min-width: 0;
            }
            
            .stat-content-mini h4 {
                font-size: var(--font-size-xs);
                color: var(--color-gray);
                margin-bottom: 4px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .value-large {
                font-size: var(--font-size-xl);
                font-weight: 700;
                color: var(--color-primary);
                margin-bottom: 2px;
                line-height: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .subtext {
                font-size: var(--font-size-xs);
                color: var(--color-gray);
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            /* Chart Statistics */
            .chart-stats {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: var(--spacing-md);
                margin-top: var(--spacing-lg);
            }
            
            .chart-stat-card {
                background: var(--color-offwhite);
                border-radius: var(--border-radius);
                padding: var(--spacing-md);
                border: var(--border-thin);
                transition: all var(--transition-fast);
            }
            
            .chart-stat-card:hover {
                transform: translateY(-2px);
                box-shadow: var(--shadow-md);
                border-color: var(--color-primary);
            }
            
            .chart-stat-card h4 {
                font-size: var(--font-size-sm);
                color: var(--color-darkgray);
                margin-bottom: var(--spacing-sm);
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
            }
            
            .chart-stat-card .value {
                font-size: var(--font-size-xl);
                font-weight: 700;
                color: var(--color-primary);
                margin-bottom: 2px;
            }
            
            .chart-stat-card .subtext {
                font-size: var(--font-size-xs);
                color: var(--color-gray);
            }
            
            /* Chart Footer */
            .chart-footer {
                margin-top: var(--spacing-lg);
                padding: var(--spacing-md);
                background: var(--color-offwhite);
                border-radius: var(--border-radius);
                border: var(--border-thin);
            }
            
            .chart-info {
                display: flex;
                align-items: center;
                gap: var(--spacing-sm);
                font-size: var(--font-size-sm);
                color: var(--color-gray);
            }
            
            /* Mobile Responsive */
            @media (max-width: 768px) {
                .stat-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: var(--spacing-sm);
                }
                
                .quick-stat-card {
                    padding: var(--spacing-sm);
                    gap: var(--spacing-sm);
                }
                
                .stat-icon-mini {
                    width: 32px;
                    height: 32px;
                    font-size: var(--font-size-sm);
                }
                
                .value-large {
                    font-size: var(--font-size-lg);
                }
                
                .chart-stats {
                    grid-template-columns: repeat(2, 1fr);
                    gap: var(--spacing-sm);
                }
                
                .chart-stat-card {
                    padding: var(--spacing-sm);
                }
                
                .chart-stat-card .value {
                    font-size: var(--font-size-lg);
                }
            }
            
            @media (max-width: 480px) {
                .stat-grid {
                    grid-template-columns: 1fr;
                }
                
                .chart-stats {
                    grid-template-columns: 1fr;
                }
            }
        `;
        document.head.appendChild(style);
    }
    </script>
</body>
</html>